---
import type { LBData } from "@/lib/listenbrainz";

interface Props {
  lb: LBData;
}

const { lb } = Astro.props;
const profileUrl = `https://listenbrainz.org/user/${lb.username}`;
const embedUrl = `https://listenbrainz.org/user/${lb.username}/embed/playing-now`;

function timeAgo(ts?: number): string {
  if (!ts) return "";
  const diff = Math.floor(Date.now() / 1000) - ts;
  if (diff < 60) return "just now";
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return `${Math.floor(diff / 86400)}d ago`;
}
---

<div class="music-card card">
  <div class="music-header">
    <h3 class="widget-title">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      <a href={profileUrl} target="_blank" rel="noopener noreferrer" class="lb-title-link">Listening</a>
    </h3>
  </div>

  {lb.available ? (
    <div class="lb-content">
      <div class="lb-now-embed">
        <iframe
          src={embedUrl}
          title="Now playing on ListenBrainz"
          frameborder="0"
          scrolling="no"
          loading="lazy"
        ></iframe>
      </div>

      {lb.recentTracks.length > 0 && (
        <div class="lb-recent-section">
          <span class="lb-recent-label">Recent</span>
          <ul class="lb-recent">
            {lb.recentTracks.slice(0, 4).map((t) => (
              <li class="lb-track">
                {t.coverArtUrl && (
                  <img
                    class="lb-cover"
                    src={t.coverArtUrl}
                    alt=""
                    loading="lazy"
                    onerror="this.style.display='none'"
                  />
                )}
                <div class="lb-info">
                  <span class="lb-name">
                    {t.listenUrl ? (
                      <a href={t.listenUrl} target="_blank" rel="noopener noreferrer">{t.trackName}</a>
                    ) : t.trackName}
                  </span>
                  <span class="lb-artist">{t.artistName}</span>
                </div>
                <span class="lb-time">{timeAgo(t.listenedAt)}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {lb.recentTracks.length === 0 && (
        <div class="lb-empty">
          <span class="text-muted text-xs">No recent listens yet</span>
        </div>
      )}
    </div>
  ) : (
    <div class="lb-empty">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      <span class="text-muted text-xs">Connect ListenBrainz to see listening activity</span>
    </div>
  )}
</div>

<style>
  .music-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 220px;
    overflow: hidden;
  }

  .music-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .lb-title-link {
    color: inherit;
    text-decoration: none;
  }

  .lb-title-link:hover {
    color: var(--accent);
  }

  .lb-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    overflow: hidden;
  }

  .lb-now-embed {
    border-radius: var(--radius-sm);
    overflow: hidden;
    height: 85px;
    flex-shrink: 0;
    background: var(--bg-surface-hover);
  }

  .lb-now-embed iframe {
    width: calc(100% + 2px);
    height: 85px;
    border: none;
    display: block;
    margin: -1px;
  }

  .lb-recent-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    overflow: hidden;
  }

  .lb-recent-label {
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }

  .lb-recent {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    overflow: hidden;
  }

  .lb-track {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    transition: background var(--duration-fast) var(--ease-out);
  }

  .lb-track:hover {
    background: var(--bg-surface-hover);
  }

  .lb-cover {
    width: 32px;
    height: 32px;
    border-radius: 3px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--border);
  }

  .lb-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .lb-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lb-name a {
    color: inherit;
    text-decoration: none;
  }

  .lb-name a:hover {
    color: var(--accent);
  }

  .lb-artist {
    font-size: var(--text-xs);
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lb-time {
    font-size: var(--text-xs);
    color: var(--text-muted);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .lb-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  @media (max-width: 900px) {
    .music-card {
      min-height: 180px;
    }
  }
</style>
